---
layout: post
title:  "Gumbel-Softmax"
date:   2021-10-15
categories: deeplearning math
author: moontree
---

åœ¨è¯» [Stochastic Loss Function](https://ojs.aaai.org//index.php/AAAI/article/view/5925) è¿™ç¯‡è®ºæ–‡çš„æ—¶å€™ï¼Œ
å‘ç°äº†ä¸€ä¸ªä¹‹å‰ä»æœªå¬è¿‡çš„åè¯ï¼šGumbel Softmaxï¼Œåœ¨ä¸€æ¢ç©¶ç«Ÿçš„åŒæ—¶åšä¸‹ç®€å•è®°å½•ã€‚

## Gumbel-Softmax Trick

### èƒŒæ™¯
åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œå¦‚æœåŠ¨ä½œç©ºé—´æ˜¯ç¦»æ•£çš„ï¼Œæ¯”å¦‚ä¸Šã€ä¸‹ã€å·¦ã€å³å››ä¸ªåŠ¨ä½œï¼Œé€šå¸¸çš„åšæ³•æ˜¯ç½‘ç»œè¾“å‡ºä¸€ä¸ªå››ç»´çš„one-hotå‘é‡(ä¸è€ƒè™‘ç©ºåŠ¨ä½œ)ï¼Œ
åˆ†åˆ«ä»£è¡¨å››ä¸ªåŠ¨ä½œã€‚æ¯”å¦‚[1,0,0,0]ä»£è¡¨ä¸Šï¼Œ[0,1,0,0]ä»£è¡¨ä¸‹ç­‰ç­‰ã€‚
è€Œå…·ä½“å–å“ªä¸ªåŠ¨ä½œå‘¢ï¼Œå°±æ ¹æ®è¾“å‡ºçš„æ¯ä¸ªç»´åº¦çš„å¤§å°ï¼Œé€‰æ‹©å€¼æœ€å¤§çš„ä½œä¸ºè¾“å‡ºåŠ¨ä½œ,å³argmax(ğ‘£)ã€‚

ä¾‹å¦‚ç½‘ç»œè¾“å‡ºçš„å››ç»´å‘é‡ä¸ºğ‘£=[âˆ’20,10,9.6,6.2]ï¼Œç¬¬äºŒä¸ªç»´åº¦å–åˆ°æœ€å¤§å€¼10ï¼Œé‚£ä¹ˆè¾“å‡ºçš„åŠ¨ä½œå°±æ˜¯[0,1,0,0]ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™å’Œå¤šç±»åˆ«çš„åˆ†ç±»ä»»åŠ¡æ˜¯ä¸€ä¸ªé“ç†ã€‚
ä½†æ˜¯è¿™ç§å–æ³•æœ‰ä¸ªé—®é¢˜æ˜¯ä¸èƒ½è®¡ç®—æ¢¯åº¦ï¼Œä¹Ÿå°±ä¸èƒ½æ›´æ–°ç½‘ç»œã€‚é€šå¸¸çš„åšæ³•æ˜¯åŠ softmaxå‡½æ•°ï¼ŒæŠŠå‘é‡å½’ä¸€åŒ–ï¼Œè¿™æ ·æ—¢èƒ½è®¡ç®—æ¢¯åº¦ï¼ŒåŒæ—¶å€¼çš„å¤§å°è¿˜èƒ½è¡¨ç¤ºæ¦‚ç‡çš„å«ä¹‰ã€‚

å°†$ğ‘£=[âˆ’20,10,9.6,6.2]$é€šè¿‡softmaxå‡½æ•°åæœ‰$ğœ(ğ‘£)=[0,0.591,0.396,0.013]$ï¼Œ
è¿™æ ·åšä¸ä¼šæ”¹å˜åŠ¨ä½œæˆ–è€…è¯´ç±»åˆ«çš„é€‰å–ï¼ŒåŒæ—¶softmaxå€¾å‘äºè®©æœ€å¤§å€¼çš„æ¦‚ç‡æ˜¾è‘—å¤§äºå…¶ä»–å€¼ï¼Œ
æ¯”å¦‚è¿™é‡Œ10å’Œ9.6ç»è¿‡softmaxæ”¾ç¼©ä¹‹åå˜æˆäº†0.591å’Œ0.396ï¼Œ6.2å¯¹åº”çš„æ¦‚ç‡æ›´æ˜¯å˜æˆäº†0.013ï¼Œ
è¿™æœ‰åˆ©äºæŠŠç½‘ç»œè®­æˆä¸€ä¸ªone-hotè¾“å‡ºçš„å½¢å¼ï¼Œè¿™ç§æ–¹å¼åœ¨åˆ†ç±»é—®é¢˜ä¸­æ˜¯å¸¸ç”¨æ–¹æ³•ã€‚

ä½†æ˜¯è¿™ä¹ˆåšè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªè¡¨ç¤ºæ¦‚ç‡çš„å‘é‡ğœ(ğ‘£)=[0,0.591,0.396,0.013]å¹¶æ²¡æœ‰çœŸæ­£æ˜¾ç¤ºå‡ºæ¦‚ç‡çš„å«ä¹‰ï¼Œ
å› ä¸ºä¸€æ—¦æŸä¸ªå€¼æœ€å¤§ï¼Œå°±é€‰æ‹©ç›¸åº”çš„åŠ¨ä½œæˆ–è€…åˆ†ç±»ã€‚æ¯”å¦‚ğœ(ğ‘£)=[0,0.591,0.396,0.013]å’Œğœ(ğ‘£)=[0,0.9,0.1,0]åœ¨ç±»åˆ«é€‰å–çš„ç»“æœçœ‹æ¥æ²¡æœ‰ä»»ä½•å·®åˆ«ï¼Œ
éƒ½æ˜¯é€‰æ‹©ç¬¬äºŒä¸ªç±»åˆ«ï¼Œä½†æ˜¯ä»æ¦‚ç‡æ„ä¹‰ä¸Šè®²å·®åˆ«æ˜¯å·¨å¤§çš„ã€‚

å¯¹äºåˆ†ç±»é—®é¢˜æ¥è¯´ï¼Œsoftmaxå·²ç»è¶³å¤Ÿä½¿ç”¨äº†ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³ç”¨è¿™ä¸ªæ¦‚ç‡å€¼å»ç”Ÿæˆæ ·æœ¬ï¼Œç”¨äºåç»­è®­ç»ƒï¼Œargmax()å°±ä¸å†é€‚ç”¨äº†ã€‚
ä½†æ˜¯ç›´æ¥æŒ‰ç…§æ¦‚ç‡è¿›è¡Œé‡‡æ ·ï¼Œä¼šå¯¼è‡´æ¢¯åº¦æ— æ³•å›ä¼ ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ Re-parameterization Trickå°±æ˜¯ç”¨äº†è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚


### Re-parameterization Trick
ä»è‡ªç¼–ç å™¨å¼€å§‹è¯´èµ·ï¼ŒåŸå§‹çš„è‡ªç¼–ç å™¨æ˜¯è¿™æ ·å­çš„ï¼šå›¾åƒç»è¿‡ç½‘ç»œæ˜ å°„åˆ°embeddingï¼Œdecoderéƒ¨åˆ†ä»embeddingé‡å»ºå›¾åƒã€‚

![](/static/img/self_encoder_ori.jpeg)

è€ŒVAEå¹¶ä¸æ˜¯ç›´æ¥å–æå–ç‰¹å¾å‘é‡ï¼Œè€Œæ˜¯æå–å›¾åƒçš„åˆ†å¸ƒç‰¹å¾:å‡å€¼å’Œæ ‡å‡†å·®ï¼Œå†æ ¹æ®å‡å€¼å’Œæ ‡å‡†å·®é‡‡æ ·ç”Ÿäº§ç‰¹å¾å‘é‡æ ·æœ¬ï¼Œç”¨äºé‡å»ºå›¾åƒã€‚

![](/static/img/vae.png)

å¦‚æœå°†é‡‡æ ·æ­¥éª¤å†™åœ¨è®¡ç®—å›¾é‡Œçš„è¯ï¼Œè¿™éƒ¨åˆ†å°±æ²¡æ³•è®¡ç®—æ¢¯åº¦äº†ï¼Œè€Œé‡å‚æ•°æŠ€å·§å°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚

![](/static/img/reparameterise.png)

å‡è®¾å›¾ä¸­çš„ğ‘¥å’Œğœ™è¡¨ç¤ºVAEä¸­çš„å‡å€¼å’Œæ ‡å‡†å·®å‘é‡ï¼Œå®ƒä»¬æ˜¯ç¡®å®šæ€§çš„èŠ‚ç‚¹ã€‚è€Œéœ€è¦è¾“å‡ºçš„æ ·æœ¬ğ‘§æ˜¯å¸¦æœ‰éšæœºæ€§çš„èŠ‚ç‚¹ï¼Œ
é‡å‚æ•°å°±æ˜¯æŠŠå¸¦æœ‰éšæœºæ€§çš„ğ‘§å˜æˆç¡®å®šæ€§çš„èŠ‚ç‚¹ï¼ŒåŒæ—¶éšæœºæ€§ç”¨å¦ä¸€ä¸ªè¾“å…¥èŠ‚ç‚¹ğœ–ä»£æ›¿ã€‚
ä¾‹å¦‚ï¼Œè¿™é‡Œç”¨æ­£æ€åˆ†å¸ƒé‡‡æ ·ï¼ŒåŸæœ¬ä»å‡å€¼ä¸ºğ‘¥å’Œæ ‡å‡†å·®ä¸ºğœ™çš„æ­£æ€åˆ†å¸ƒ$ğ‘(ğ‘¥,ğœ™^2)$ä¸­é‡‡æ ·å¾—åˆ°ğ‘§ã€‚
å°†å…¶è½¬åŒ–æˆä»æ ‡å‡†æ­£æ€åˆ†å¸ƒğ‘(0,1)ä¸­é‡‡æ ·å¾—åˆ°ğœ–,å†è®¡ç®—å¾—åˆ°$ğ‘§=ğ‘¥+ğœ–â‹…ğœ™$ã€‚
è¿™æ ·ä¸€æ¥ï¼Œé‡‡æ ·çš„è¿‡ç¨‹ç§»å‡ºäº†è®¡ç®—å›¾ï¼Œæ•´å¼ è®¡ç®—å›¾å°±å¯ä»¥è®¡ç®—æ¢¯åº¦è¿›è¡Œæ›´æ–°äº†ï¼Œ
è€Œæ–°åŠ çš„ğœ–çš„è¾“å…¥åˆ†æ”¯ä¸åšæ›´æ–°ï¼Œåªå½“æˆä¸€ä¸ªæ²¡æœ‰æƒé‡å˜åŒ–çš„è¾“å…¥ã€‚

æ•´ä¸ªè¿‡ç¨‹å’Œbatch normalizationæ¯”è¾ƒåƒï¼Œåªä¸è¿‡æ˜¯ç”¨éšæœºè¾“å…¥ä»£æ›¿äº†inferenceæ—¶çš„è¾“å…¥ã€‚

### Gumbel-Softmax Trick

VAEçš„ä¾‹å­æ˜¯ä¸€ä¸ªè¿ç»­åˆ†å¸ƒï¼ˆæ­£æ€åˆ†å¸ƒï¼‰çš„é‡å‚æ•°ï¼Œå¼•å…¥äº†ä¸€å®šçš„éšæœºæ€§ï¼Œè€Œç¦»æ•£åˆ†å¸ƒçš„é‡‡æ ·ï¼Œå°±éœ€è¦ç”¨åˆ°Gumbel-Softmaxäº†ã€‚

å‡è®¾æ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡æ˜¯$p_1, p_2, ..., p_k$ï¼Œå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä¾ç…§æ¦‚ç‡å¯¹ç±»åˆ«è¿›è¡Œé‡‡æ ·,ç§°ä¸ºiGumbel-Maxï¼Œåç»­ç»™å‡ºä¸¤è€…ç­‰ä»·çš„è¯æ˜ã€‚

$$
argmax (\log p_i - \log(-\log \epsilon_i))_{i=1}^k, \epsilon_iâˆ¼U[0,1]
$$


ä¹Ÿå°±æ˜¯è¯´ï¼Œå…ˆç®—å‡ºå„ä¸ªæ¦‚ç‡çš„å¯¹æ•°$\log p_i$ï¼Œç„¶åä»å‡åŒ€åˆ†å¸ƒ$U[0,1]$ä¸­é‡‡æ ·kä¸ªéšæœºæ•°$\epsilon_1,â€¦,\epsilon_k$ï¼Œ
æŠŠ$\log(âˆ’\log \epsilon_i)$åŠ åˆ°$\log p_i$ä¸Šå»ï¼Œæœ€åæŠŠæœ€å¤§å€¼å¯¹åº”çš„ç±»åˆ«æŠ½å–å‡ºæ¥å°±è¡Œäº†ã€‚
é€šè¿‡è¿™ç§æ–¹å¼ï¼Œéšæœºæ€§è½¬ç§»åˆ°U[0,1]ä¸Šï¼Œå¹¶ä¸”ä¸å¸¦æœ‰æœªçŸ¥å‚æ•°ï¼Œå®Œæˆäº†ç¦»æ•£åˆ†å¸ƒçš„é‡å‚æ•°è¿‡ç¨‹ã€‚

ä¸ºäº†ä¿è¯å¯åˆ°ï¼Œå°†GumbelMaxæ›¿æ¢ä¸ºå…‰æ»‘ç‰ˆæœ¬-Gumbel Softmax

$$
softmax((\log p_i âˆ’ \log(âˆ’\log \epsilon_i))/\tau)^k_{i=1} ,\epsilon_iâˆ¼U[0,1]
$$

![](/static/img/gumbel_sample_of_different_t.png)

$\tau > 0$ ä¸ºé€€ç«å‚æ•°ï¼Œå€¼è¶Šå°ï¼Œç»“æœå°±è¶Šæ¥è¿‘one-hotå½¢å¼ï¼Œè¶Šå¤§å°±è¶Šæ¥è¿‘ç­‰æ¦‚ç‡æŠ½æ ·ã€‚ æœ‰ä¸€ä¸ªå°æŠ€å·§ï¼š
å¦‚æœ$p_i$æ˜¯softmaxçš„è¾“å‡ºï¼Œé‚£ä¹ˆå¤§å¯ä¸å¿…å…ˆç®—å‡º$p_i$å†å–å¯¹æ•°ï¼Œç›´æ¥å°†$\log p_i$æ›¿æ¢ä¸º$o_i$å³å¯ï¼š

$$
softmax((\log o_i âˆ’ \log(âˆ’\log \epsilon_i))/\tau)^k_{i=1} ,\epsilon_iâˆ¼U[0,1]
$$

è¯æ˜è¿‡ç¨‹å¦‚ä¸‹ï¼š

![](/static/img/gumbel_max.jpeg)


## [Gumbel Distribution](https://en.wikipedia.org/wiki/Gumbel_distribution)

Gumbel Distribution æ˜¯ä¸€ä¸ªå…³äº"æœ€å¤§å€¼"çš„æ¦‚ç‡çš„åˆ†å¸ƒï¼Œæ¯”å¦‚å·²çŸ¥è¿‡å»100å¹´æ²³æµçš„æ°´ä½æƒ…å†µï¼Œé‚£ä¹ˆgumbelåˆ†å¸ƒå¯ä»¥ç”¨äºé¢„æµ‹æ˜å¹´æ²³æµçš„æœ€å¤§æ°´ä½åˆ†å¸ƒï¼Œ
ä¼šç»™å‡ºæ¯ä¸ªå€¼æ˜¯"æœ€å¤§å€¼"çš„æ¦‚ç‡ã€‚

$$
z = \frac{x - \mu}{\beta}
$$

ç´¯ç§¯åˆ†å¸ƒå‡½æ•°å¦‚ä¸‹ï¼š

$$
F(x:\mu,\beta)=e^{-e^z}
$$

æ¦‚ç‡å¯†åº¦å‡½æ•°å¦‚ä¸‹ï¼š

$$
f(x:\mu,\beta)=\frac{1}{\beta}e^{-(z + e^{-z})}
$$

![](/static/img/gumbel_distribuction.png)


[ä»£ç ](https://github.com/moontree/moontree.github.io/blob/master/examples/gumbel_distribuction.py)

## Reference
- [Stochastic Loss Function](https://ojs.aaai.org//index.php/AAAI/article/view/5925)
- [Gumbel Distribution](https://en.wikipedia.org/wiki/Gumbel_distribution)
- [CATEGORICAL REPARAMETERIZATION WITH GUMBEL-SOFTMAX](https://arxiv.org/pdf/1611.01144.pdf)
- [æ¼«è°ˆé‡å‚æ•°ï¼šä»æ­£æ€åˆ†å¸ƒåˆ°Gumbel Softmax](https://kexue.fm/archives/6705/comment-page-1)
- [Gumbel-Softmax Trickå’ŒGumbelåˆ†å¸ƒ](https://www.cnblogs.com/initial-h/p/9468974.html)